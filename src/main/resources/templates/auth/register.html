<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Registro | Beauty Salon</title>
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body>

<div class="auth-container">
    <h1 class="auth-title">NOVO CADASTRO</h1>

    <div id="message-container"></div>

    <form class="auth-form" id="registerForm" th:action="@{/register}" method="post">
        <div class="form-group">
            <label for="username">Usuário:</label>
            <input type="text" id="username" name="username" placeholder="Crie um nome de usuário" required>
        </div>

        <div class="form-group">
            <label for="password">Senha:</label>
            <input type="password" id="password" name="password" placeholder="••••••••" required>
        </div>

        <div class="form-group">
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" placeholder="seu@email.com" required>
        </div>

        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" id="csrfToken"/>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;">CRIAR CONTA</button>
            <a th:href="@{/login}" class="btn btn-secondary" style="width: 100%;">VOLTAR</a>
        </div>
    </form>
</div>

<script>
    document.getElementById('registerForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const form = e.target;
        const formData = new FormData(form);
        const messageContainer = document.getElementById('message-container');

        // Limpa mensagens anteriores
        messageContainer.innerHTML = '';

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRF-TOKEN': document.getElementById('csrfToken').value
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ✅ registro ok → redireciona pro login
                    window.location.href = '/login?registered=true';
                } else {
                    // ⚠️ mostra erros
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'auth-message error-message';

                    if (data.errors) {
                        data.errors.forEach(error => {
                            const p = document.createElement('p');
                            p.textContent = error;
                            errorDiv.appendChild(p);
                        });
                    } else if (data.message) {
                        const p = document.createElement('p');
                        p.textContent = data.message;
                        errorDiv.appendChild(p);
                    }

                    messageContainer.appendChild(errorDiv);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'auth-message error-message';
                errorDiv.textContent = 'Ocorreu um erro durante o registro. Por favor, tente novamente.';
                messageContainer.appendChild(errorDiv);
            });
    });
</script>

</body>
</html>
